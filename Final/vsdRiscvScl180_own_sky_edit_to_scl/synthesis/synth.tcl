# ========================================================================
# Synopsys DC Synthesis Script for vsdcaravel
# Modified to blackbox RAM128 and RAM256 modules
# Based on golden TCL with minimal modifications
# ========================================================================

# ========================================================================
# Load Technology Libraries
# ========================================================================
read_db "/home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/iopad/cio250/4M1L/liberty/tsl18cio250_min.db"
read_db "/home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/stdcell/fs120/4M1IL/liberty/lib_flow_ff/tsl18fs120_scl_ff.db"

# ========================================================================
# Set Library Variables
# ========================================================================
set target_library "/home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/iopad/cio250/4M1L/liberty/tsl18cio250_min.db /home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/stdcell/fs120/4M1IL/liberty/lib_flow_ff/tsl18fs120_scl_ff.db"
set link_library "* /home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/iopad/cio250/4M1L/liberty/tsl18cio250_min.db /home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/stdcell/fs120/4M1IL/liberty/lib_flow_ff/tsl18fs120_scl_ff.db"
set_app_var target_library $target_library
set_app_var link_library $link_library

# ========================================================================
# Define Directory Paths
# ========================================================================
set root_dir "/home/rpatel/vsdRiscvScl180"
set io_lib "/home/Synopsys/pdk/SCL_PDK_3/SCLPDK_V3.0_KIT/scl180/iopad/cio250/4M1L/verilog/tsl18cio250/zero"
set verilog_files "$root_dir/rtl"
set top_module "vsdcaravel"
set output_file "$root_dir/synthesis/output/vsdcaravel_synthesis.v"
set report_dir "$root_dir/synthesis/report"

# ========================================================================
# Configure Blackbox Handling for Memory Modules
# ========================================================================
puts "INFO: Configuring blackbox handling for RAM modules..."
set_app_var hdlin_infer_multibit default_none
set_app_var hdlin_auto_save_templates false

# ========================================================================
# Create Blackbox Stub File for RAM Modules
# ========================================================================
set blackbox_file "$root_dir/synthesis/memory_blackbox_stubs.v"
set fp [open $blackbox_file w]
puts $fp "// Blackbox definitions for memory modules"
puts $fp "// Auto-generated by synthesis script"
puts $fp ""
puts $fp "(* blackbox *)"
puts $fp "module RAM128(CLK, EN0, VGND, VPWR, A0, Di0, Do0, WE0);"
puts $fp "  input CLK, EN0, VGND, VPWR;"
puts $fp "  input \[6:0\] A0;"
puts $fp "  input \[31:0\] Di0;"
puts $fp "  input \[3:0\] WE0;"
puts $fp "  output \[31:0\] Do0;"
puts $fp "endmodule"
puts $fp ""
puts $fp "(* blackbox *)"
puts $fp "module RAM256(VPWR, VGND, CLK, WE0, EN0, A0, Di0, Do0);"
puts $fp "  input CLK, EN0;"
puts $fp "  inout VPWR, VGND;"
puts $fp "  input \[7:0\] A0;"
puts $fp "  input \[31:0\] Di0;"
puts $fp "  input \[3:0\] WE0;"
puts $fp "  output \[31:0\] Do0;"
puts $fp "endmodule"
puts $fp ""
close $fp
puts "INFO: Created blackbox stub file: $blackbox_file"

# ========================================================================
# Read Design Files
# ========================================================================
# Read defines first (as in golden script)
puts "INFO: Reading defines.v..."
read_file $verilog_files/defines.v

# Read blackbox stubs before any RTL
puts "INFO: Reading memory blackbox stubs..."
read_file $blackbox_file -format verilog

# Read IO library with autoread (as in golden script)
#puts "INFO: Reading IO library..."
#read_file $io_lib -autoread -define USE_POWER_PINS -format verilog

# Read scl180_wrapper with autoread (as in golden script)
#puts "INFO: Reading scl180_wrapper..."
#read_file $verilog_files/scl180_wrapper -autoread -define USE_POWER_PINS -format verilog

# ========================================================================
# Read Main RTL Files (Excluding RAM modules)
# ========================================================================
puts "INFO: Building RTL file list (excluding RAM128.v and RAM256.v)..."

# Get all verilog files from rtl directory
set all_rtl_files [glob -nocomplain ${verilog_files}/*.v]

# Define files to exclude
set exclude_files [list \
    "${verilog_files}/RAM128.v" \
    "${verilog_files}/RAM256.v" \
    "${verilog_files}/defines.v" \
]

# Build list of files to read (excluding RAM modules and defines which was already read)
set rtl_to_read [list]
foreach file $all_rtl_files {
    set excluded 0
    foreach excl_file $exclude_files {
        if {[string equal $file $excl_file]} {
            set excluded 1
            if {[string match "*RAM*.v" $file]} {
                puts "INFO: Excluding $file (using blackbox instead)"
            }
            break
        }
    }
    if {!$excluded} {
        lappend rtl_to_read $file
    }
}

puts "INFO: Reading [llength $rtl_to_read] RTL files..."
read_file $rtl_to_read -define USE_POWER_PINS -format verilog

# ========================================================================
# Read Timing Constraints
# ========================================================================
puts "INFO: Reading timing constraints..."
read_sdc "$root_dir/synthesis/vsdcaravel.sdc"
update_timing

# ========================================================================
# Elaborate Design
# ========================================================================
puts "INFO: Elaborating design..."
elaborate $top_module

# Verify current design context
if {[current_design] != $top_module} {
    puts "WARNING: Current design is [current_design], switching to $top_module..."
    current_design $top_module
}

# ========================================================================
# Set Blackbox Attributes for RAM Modules
# ========================================================================
puts "INFO: Setting blackbox attributes for RAM modules..."

# Mark RAM128 as blackbox
if {[sizeof_collection [get_designs -quiet RAM128]] > 0} {
    set_attribute [get_designs RAM128] is_black_box true -quiet
    set_dont_touch [get_designs RAM128]
    puts "INFO: RAM128 marked as blackbox and protected"
} else {
    puts "WARNING: RAM128 design not found"
}

# Mark RAM256 as blackbox
if {[sizeof_collection [get_designs -quiet RAM256]] > 0} {
    set_attribute [get_designs RAM256] is_black_box true -quiet
    set_dont_touch [get_designs RAM256]
    puts "INFO: RAM256 marked as blackbox and protected"
} else {
    puts "WARNING: RAM256 design not found"
}

# Protect all instances of RAM modules from optimization
puts "INFO: Protecting RAM module instances from optimization..."
foreach blackbox_ref {"RAM128" "RAM256"} {
    set instances [get_cells -quiet -hierarchical -filter "ref_name == $blackbox_ref"]
    if {[sizeof_collection $instances] > 0} {
        set_dont_touch $instances
        set inst_count [sizeof_collection $instances]
        puts "INFO: Protected $inst_count instance(s) of $blackbox_ref"
    } else {
        puts "INFO: No instances of $blackbox_ref found in design"
    }
}

# ========================================================================
# Link Design
# ========================================================================
puts "INFO: Linking design..."
link

# ========================================================================
# Uniquify and Flatten (Optional - Currently Commented Out)
# ========================================================================
# Note: These were commented out in the golden script
# Uncomment if needed for your design
#set_uniquify_design false
#set_flatten false

# ========================================================================
# Compile Design
# ========================================================================
puts "INFO: Starting compilation with compile_ultra -incremental..."
compile_ultra -incremental

# ========================================================================
# Generate Reports
# ========================================================================
puts "INFO: Generating synthesis reports..."

# Original reports from golden script
report_qor > "$report_dir/qor_post_synth.rpt"
report_area > "$report_dir/area_post_synth.rpt"
report_power > "$report_dir/power_post_synth.rpt"

# Additional reports
report_timing -max_paths 10 > "$report_dir/timing_post_synth.rpt"
report_constraint -all_violators > "$report_dir/constraints_post_synth.rpt"

# Blackbox modules report
puts "INFO: Generating blackbox module report..."
set bb_report [open "$report_dir/blackbox_modules.rpt" w]
puts $bb_report "========================================"
puts $bb_report "Blackbox Modules Report"
puts $bb_report "========================================"
puts $bb_report ""
puts $bb_report "Date: [date]"
puts $bb_report "Design: $top_module"
puts $bb_report ""

foreach bb_module {"RAM128" "RAM256"} {
    puts $bb_report "----------------------------------------"
    puts $bb_report "Module: $bb_module"
    puts $bb_report "----------------------------------------"
    
    # Check if design exists
    set design_exists [sizeof_collection [get_designs -quiet $bb_module]]
    if {$design_exists > 0} {
        puts $bb_report "  Design Status: PRESENT (blackbox)"
        
        # Check for instances
        set instances [get_cells -quiet -hierarchical -filter "ref_name == $bb_module"]
        set inst_count [sizeof_collection $instances]
        
        if {$inst_count > 0} {
            puts $bb_report "  Instance Count: $inst_count"
            puts $bb_report "  Instances:"
            foreach_in_collection inst $instances {
                puts $bb_report "    - [get_object_name $inst]"
            }
        } else {
            puts $bb_report "  Instance Count: 0 (not instantiated)"
        }
    } else {
        puts $bb_report "  Design Status: NOT FOUND"
        puts $bb_report "  Instance Count: N/A"
    }
    puts $bb_report ""
}

puts $bb_report "========================================"
puts $bb_report "End of Blackbox Report"
puts $bb_report "========================================"
close $bb_report
puts "INFO: Blackbox report written to: $report_dir/blackbox_modules.rpt"

# ========================================================================
# Write Output Files
# ========================================================================
puts "INFO: Writing output files..."

# Write Verilog netlist (as in golden script)
write -format verilog -hierarchy -output $output_file
puts "INFO: Netlist written to: $output_file"

# Write DDC format for place-and-route
write -format ddc -hierarchy -output "$root_dir/synthesis/output/vsdcaravel_synthesis.ddc"
puts "INFO: DDC written to: $root_dir/synthesis/output/vsdcaravel_synthesis.ddc"

# Write SDC with actual timing constraints
write_sdc "$root_dir/synthesis/output/vsdcaravel_synthesis.sdc"
puts "INFO: SDC written to: $root_dir/synthesis/output/vsdcaravel_synthesis.sdc"

# ========================================================================
# Summary
# ========================================================================
puts ""
puts "========================================"
puts "Synthesis Complete!"
puts "========================================"
puts "Output netlist: $output_file"
puts "DDC file: $root_dir/synthesis/output/vsdcaravel_synthesis.ddc"
puts "SDC file: $root_dir/synthesis/output/vsdcaravel_synthesis.sdc"
puts "Reports directory: $report_dir"
puts "Blackbox stub file: $blackbox_file"
puts ""
puts "NOTE: The following modules are preserved as blackboxes:"
puts "  - RAM128 (Memory macro)"
puts "  - RAM256 (Memory macro)"
puts "These modules must be replaced with actual macros during P&R"
puts "========================================"
puts ""

# Uncomment to exit dc_shell automatically
# exit
